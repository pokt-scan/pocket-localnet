version: "3.4"

x-base-pocket-core: &base-pocket-core
  build:
    context: $POCKET_CORE_PATH
    dockerfile: .github/workflows/Dockerfile
  image: poktscan/pocket-core:dev
  command: [ "pocket", "start", "--datadir=/home/app/.pocket/", "--keybase=false", "--forceSetValidators"]
  # if u ran into a permission issue, please comment command and uncomment below commented lines
  # run docker compose up <service> then comment this back again and uncomment your command
  #  entrypoint: [ "/home/app/fix_permissions.sh", "/home/app/.pocket"]
  #  user: root
  restart: unless-stopped
  healthcheck:
    interval: 10s
    timeout: 1s
    retries: 10
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 3G
  logging:
    options:
      mode: non-blocking
      max-size: "10m"
      max-file: "3"

services:
  
  lean1:
    <<: *base-pocket-core
    container_name: lean1_localnet
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://lean1.dev:8071/v1/health" ]
    ports:
      - "8071:8071" # pokt rpc
      - "8073:8073" # prometheus
      - "26646:26646/tcp" # tendermint peer
      - "26646:26646/udp" # tendermint peer
      - "26647:26647" # tendermint rpc
    expose:
      - "26646"
    volumes:
      # Data
      - lean1:/home/app/.pocket
      
      # Exclusive main files
      - ./lean1/config.json:/home/app/.pocket/config/config.json
      - ./lean1/lean_nodes_keys.json:/home/app/.pocket/lean_nodes_keys.json
      
      # Common nodes files
      - ./config/genesis.json:/home/app/.pocket/config/genesis.json
      - ./config/chains.json:/home/app/.pocket/config/chains.json
      - ./config/auth.json:/home/app/.pocket/config/auth.json
    hostname: lean1.dev
    networks:
      pocket_localnet:
        aliases:
          - lean1.dev
  
  lean2:
    <<: *base-pocket-core
    container_name: lean2_localnet
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://lean2.dev:8081/v1/health" ]
    ports:
      - "8081:8081" # pokt rpc
      - "8083:8083" # prometheus
      - "26656:26656/tcp" # tendermint peer
      - "26656:26656/udp" # tendermint peer
      - "26657:26657" # tendermint rpc
    expose:
      - "26656"
    volumes:
      # Data
      - lean2:/home/app/.pocket
      
      # Exclusive main files
      - ./lean2/config.json:/home/app/.pocket/config/config.json
      - ./lean2/lean_nodes_keys.json:/home/app/.pocket/lean_nodes_keys.json
      
      # Common nodes files
      - ./config/genesis.json:/home/app/.pocket/config/genesis.json
      - ./config/chains.json:/home/app/.pocket/config/chains.json
      - ./config/auth.json:/home/app/.pocket/config/auth.json
    hostname: lean2.dev
    networks:
      pocket_localnet:
        aliases:
          - lean2.dev
  
  lean3:
    <<: *base-pocket-core
    container_name: lean3_localnet
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://lean3.dev:8091/v1/health" ]
    ports:
      - "8091:8091" # pokt rpc
      - "8093:8093" # prometheus
      - "26666:26666/tcp" # tendermint peer
      - "26666:26666/udp" # tendermint peer
      - "26667:26667" # tendermint rpc
    expose:
      - "26666"
    volumes:
      # Data
      - lean3:/home/app/.pocket
      
      # Exclusive main files
      - ./lean3/config.json:/home/app/.pocket/config/config.json
      - ./lean3/lean_nodes_keys.json:/home/app/.pocket/lean_nodes_keys.json
      
      # Common nodes files
      - ./config/genesis.json:/home/app/.pocket/config/genesis.json
      - ./config/chains.json:/home/app/.pocket/config/chains.json
      - ./config/auth.json:/home/app/.pocket/config/auth.json
    hostname: lean3.dev
    networks:
      pocket_localnet:
        aliases:
          - lean3.dev
  
  mesh:
    <<: *base-pocket-core
    container_name: nmesh_localnet
    command: [ "pocket", "start-mesh", "--datadir=/home/app/.pocket/" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9081/v1/health" ]
    ports:
      - "9081:9081" # pokt rpc
      - "9084:9084" # prometheus
    volumes:
      # Data
      - mesh:/home/app/.pocket
      # Exclusive main files
      - ./mesh/config.json:/home/app/.pocket/config/config.json
      - ./mesh/keys.json:/home/app/.pocket/key/keys.json
      # Common nodes files
      - ./config/auth.json:/home/app/.pocket/key/auth.json
      - ./config/chains.json:/home/app/.pocket/chains/chains.json
    hostname: mesh.dev
    networks:
      pocket_localnet:
        aliases:
          - mesh.dev
    depends_on:
      lean1:
        condition: service_healthy
      lean2:
        condition: service_healthy
      lean3:
        condition: service_healthy

networks:
  pocket_localnet:

volumes:
  lean1:
    labels:
      pocket: localnet
  lean2:
    labels:
      pocket: localnet
  lean3:
    labels:
      pocket: localnet
  mesh:
    labels:
      pocket: localnet
